(function(n,g){typeof exports=="object"&&typeof module<"u"?module.exports=g(require("esri/config"),require("esri/geometry/Extent"),require("esri/geometry/Point"),require("esri/geometry/SpatialReference"),require("esri/Graphic"),require("esri/layers/GraphicsLayer"),require("esri/layers/support/TileInfo"),require("esri/Map"),require("esri/views/MapView"),require("esri/widgets/ScaleBar"),require("esri/geometry/Polyline"),require("esri/geometry/projection"),require("esri/request"),require("esri/Basemap"),require("esri/identity/IdentityManager"),require("esri/layers/FeatureLayer"),require("esri/layers/ImageryLayer"),require("esri/layers/MapImageLayer"),require("esri/layers/TileLayer"),require("esri/layers/VectorTileLayer"),require("esri/layers/WMTSLayer"),require("esri/core/accessorSupport/decorators/property"),require("esri/core/accessorSupport/decorators/subclass"),require("esri/layers/BaseTileLayer"),require("esri/rest/query"),require("esri/symbols/PictureMarkerSymbol"),require("esri/widgets/BasemapGallery"),require("esri/widgets/BasemapGallery/support/LocalBasemapsSource"),require("esri/widgets/CoordinateConversion"),require("esri/widgets/CoordinateConversion/support/Conversion"),require("esri/widgets/CoordinateConversion/support/Format"),require("esri/widgets/Expand"),require("esri/widgets/LayerList"),require("esri/core/accessorSupport/decorators"),require("esri/core/reactiveUtils"),require("esri/widgets/support/widget"),require("esri/widgets/Widget")):typeof define=="function"&&define.amd?define(["esri/config","esri/geometry/Extent","esri/geometry/Point","esri/geometry/SpatialReference","esri/Graphic","esri/layers/GraphicsLayer","esri/layers/support/TileInfo","esri/Map","esri/views/MapView","esri/widgets/ScaleBar","esri/geometry/Polyline","esri/geometry/projection","esri/request","esri/Basemap","esri/identity/IdentityManager","esri/layers/FeatureLayer","esri/layers/ImageryLayer","esri/layers/MapImageLayer","esri/layers/TileLayer","esri/layers/VectorTileLayer","esri/layers/WMTSLayer","esri/core/accessorSupport/decorators/property","esri/core/accessorSupport/decorators/subclass","esri/layers/BaseTileLayer","esri/rest/query","esri/symbols/PictureMarkerSymbol","esri/widgets/BasemapGallery","esri/widgets/BasemapGallery/support/LocalBasemapsSource","esri/widgets/CoordinateConversion","esri/widgets/CoordinateConversion/support/Conversion","esri/widgets/CoordinateConversion/support/Format","esri/widgets/Expand","esri/widgets/LayerList","esri/core/accessorSupport/decorators","esri/core/reactiveUtils","esri/widgets/support/widget","esri/widgets/Widget"],g):(n=typeof globalThis<"u"?globalThis:n||self,n.mapcontrol=g(n["esri/config"],n.esriExtent,n.esriPoint,n.esriSpatialReference,n.esriGraphic,n.esriGraphicsLayer,n.esriTileInfo,n.esriMap,n.esriMapView,n.esriScaleBar,n.esriPolyline,n.esriprojection,n.esriRequest,n.esriBasemap,n.esriId,n.esriFeatureLayer,n.esriImageryLayer,n.esriMapImageLayer,n.esriTileLayer,n.esriVectorTileLayer,n.esriWMTSLayer,n.property,n.subclass,n.BaseTileLayer,n.esriquery,n.esriPictureMarkerSymbol,n.esriBasemapGallery,n.esriLocalBasemapsSource,n.esriCoordinateConversion,n.esriConversion,n.esriFormat,n.esriExpand,n.esriLayerList,n.esridecorators,n.esriReactiveUtils,n.esriwidget,n.esriWidget))})(this,function(n,g,u,q,m,G,L,C,P,O,E,k,f,F,D,j,V,_,R,A,N,z,W,J,K,H,X,Y,Z,Q,ee,w,te,B,re,ie,se){"use strict";function T(l){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(l){for(const t in l)if(t!=="default"){const r=Object.getOwnPropertyDescriptor(l,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:()=>l[t]})}}return e.default=l,Object.freeze(e)}const M=T(k),ae=T(K),oe=T(re);let ne=()=>({emit(l,...e){let t=this.events[l]||[];for(let r=0,i=t.length;r<i;r++)t[r](...e)},events:{},on(l,e){var t;return(t=this.events[l])!=null&&t.push(e)||(this.events[l]=[e]),()=>{var r;this.events[l]=(r=this.events[l])==null?void 0:r.filter(i=>e!==i)}}});class ce{static gpxToFeatures(e,t){return new Promise(r=>{f(e,{responseType:"xml"}).then(i=>{const s=i.data;M.load().then(()=>{const a={waypoints:[],tracks:[]};s.querySelectorAll("wpt").forEach((o,c)=>{const p=new u({latitude:o.attributes.lat.value,longitude:o.attributes.lon.value}),h=this.getGraphic(p,o,`waypoint ${c+1}`,t);a.waypoints.push(h)}),s.querySelectorAll("trk").forEach((o,c)=>{const p=new E({paths:[],spatialReference:{wkid:4326}});o.querySelectorAll("trkseg").forEach(d=>{const y=[];d.querySelectorAll("trkpt").forEach($=>{const we=new u({latitude:$.attributes.lat.value,longitude:$.attributes.lon.value});y.push(we)}),p.addPath(y)});const h=this.getGraphic(p,o,`track ${c+1}`,t);a.tracks.push(h)}),s.querySelectorAll("rte").forEach((o,c)=>{const p=new E({paths:[],spatialReference:{wkid:4326}}),h=[];o.querySelectorAll("rtept").forEach(y=>{const S=new u({latitude:y.attributes.lat.value,longitude:y.attributes.lon.value});h.push(S)}),p.addPath(h);const d=this.getGraphic(p,o,`route ${c+1}`,t);a.tracks.push(d)}),r(a)})})})}static getGraphic(e,t,r,i){const s=t.querySelector("name");let a=r;s&&(a=s.textContent);const o=t.querySelector("desc");let c="";o&&(c=o.textContent);const p={title:a,content:c};return new m({geometry:M.project(e,i),popupTemplate:p})}}var le=Object.defineProperty,pe=Object.getOwnPropertyDescriptor,I=(l,e,t,r)=>{for(var i=r>1?void 0:r?pe(e,t):e,s=l.length-1,a;s>=0;s--)(a=l[s])&&(i=(r?a(e,t,i):a(i))||i);return r&&i&&le(e,t,i),i};let v=class extends J{constructor(l){super();const e=new q({wkid:2056}),t=L.create({spatialReference:e,numLODs:l.scales.length,scales:l.scales});t.origin=new u({x:242e4,y:135e4,spatialReference:e}),this.title=l.title,this.urlTemplate=l.urlTemplate,this.spatialReference=e,this.tileInfo=t}getTileUrl(l,e,t){return this.urlTemplate.replace("{level}",l.toString()).replace("{col}",t.toString()).replace("{row}",e.toString())}};I([z.property()],v.prototype,"urlTemplate",2),v=I([W.subclass("esri.layers.SwissTileLayer")],v);class he{constructor(e){this.serviceDescription=null,this.config=e,this.serviceUrl=e.vectorServiceUrl;const t=e.vectorServiceToken;D.registerToken({token:t,server:`${this.serviceUrl.split("/rest/services")[0]}/rest/services`})}getFeatureLayers(e){return new Promise(t=>{this.getServiceDescription().then(r=>{const i=[];r.layers.forEach(s=>{if(e.includes(s.name)){const a=new j({url:`${this.serviceUrl}/${s.id}`,title:s.name});a.on("layerview-create",o=>{const c=o.layerView.layer;c.popupTemplate=c.createPopupTemplate()}),i.push(a)}}),t(i)})})}async getMapImageLayers(e){const t=[];return(await this.getServiceDescription()).layers.forEach(i=>{if(e.includes(i.name)){const s=new _({title:i.name,url:this.serviceUrl,listMode:"hide-children",sublayers:[{id:i.id,visible:!0}]}),a=s.sublayers.at(0);a.load().then(()=>{a.popupEnabled=!0,a.popupTemplate=a.createPopupTemplate(),a.popupTemplate.title=`${i.name}: {${a.sourceJSON.displayField}}`}),t.push(s)}}),t}queryLayer(e,t){return new Promise(r=>{this.getServiceDescription().then(i=>{const s=i.layers.filter(c=>c.name===e.layer)[0];if(!s){console.warn(`Invalid layer name in config file: ${e.layer}`),r([]);return}const a=s.fields.filter(c=>c.name===e.field)[0];if(!a){console.warn(`Invalid field name in config file: ${e.field}`),r([]);return}let o;this.isNumericField(a.type)?o=`${e.field} in (${t.join(",")})`:o=`${e.field} in ('${t.join("','")}')`,ae.executeQueryJSON(`${this.serviceUrl}/${s.id}`,{where:o,returnGeometry:!0}).then(c=>{r(c.features.map(p=>p.geometry))})})})}getBasemaps(e){const t=[];return e.forEach(r=>{const i=this.getLayer(r);i&&t.push(new F({baseLayers:[i],title:r.alias,thumbnailUrl:r.thumbnailUrl}))}),t}getServiceDescription(){return new Promise(e=>{this.serviceDescription===null?f(`${this.serviceUrl}/layers`,{query:{f:"json"},responseType:"json"}).then(t=>{this.serviceDescription=t.data,e(this.serviceDescription)}):e(this.serviceDescription)})}getLayer(e){switch(e.type){case"tile":return new v({title:e.alias,urlTemplate:e.urlTemplate,scales:this.config.scales});case"wmts":return new N({url:e.url,activeLayer:{id:e.layerId},copyright:e.copyright});case"mapservice":return new R({url:e.url,copyright:e.copyright});case"imageservice":return new V({url:e.url,copyright:e.copyright});case"vectortile":return new A({url:e.url});default:return console.warn(`Unsupported basemap type: ${e.type}`),null}}isNumericField(e){return e==="esriFieldTypeSmallInteger"||e==="esriFieldTypeInteger"||e==="esriFieldTypeSingle"||e==="esriFieldTypeDouble"}}class ue{static txtToFeatures(e,t){return new Promise(r=>{f(e,{responseType:"text"}).then(i=>{const s=[];i.data.split(`
`).forEach((a,o)=>{if(o){const c=a.split("	");if(c.length>=5){const p=c[0].split(","),h=new u({x:parseFloat(p[1]),y:parseFloat(p[0]),spatialReference:t}),d={title:c[1],content:c[2]},y=c[4].split(","),S=new H({url:c[3],width:`${y[0]}px`,height:`${y[1]}px`});s.push(new m({geometry:h,symbol:S,popupTemplate:d}))}}}),r(s)})})}}var de=Object.defineProperty,ye=Object.getOwnPropertyDescriptor,U=(l,e,t,r)=>{for(var i=r>1?void 0:r?ye(e,t):e,s=l.length-1,a;s>=0;s--)(a=l[s])&&(i=(r?a(e,t,i):a(i))||i);return r&&i&&de(e,t,i),i};let x=class extends se{constructor(l){super(l)}postInitialize(){oe.watch(()=>[this.mainView.center,this.mainView.interacting,this.mainView.scale],()=>{this.onViewChange()})}render(){return setTimeout(()=>{this.expand.expanded&&this.onViewChange()},10),ie.tsx("div",{id:`${this.id}_cont`,style:"width:250px;height:150px;background:#fff"})}onViewChange(){this.expand.expanded&&(!this.overview&&document.getElementById(`${this.id}_cont`)&&(this.createMap(),this.createExtentGraphic()),this.overview&&(this.overview.center=this.mainView.center,this.overview.scale=this.mainView.scale*this.factor,this.extentGraphic.geometry=this.mainView.extent))}createMap(){const l=new C({basemap:this.basemap}),e=L.create({spatialReference:this.mainView.spatialReference,numLODs:this.scales.length,scales:this.scales});this.overview=new P({container:`${this.id}_cont`,map:l,scale:this.mainView.scale,center:this.mainView.center,spatialReference:this.mainView.spatialReference,constraints:{rotationEnabled:!1,lods:e.lods},ui:{components:[]}}),this.overview.when(()=>{const t=r=>{r.stopPropagation()};this.overview.on("mouse-wheel",t),this.overview.on("double-click",t),this.overview.on("double-click",["Control"],t),this.overview.on("drag",t),this.overview.on("drag",["Shift"],t),this.overview.on("drag",["Shift","Control"],t),this.overview.on("key-down",r=>{const i=["+","-","Shift","_","=","ArrowUp","ArrowDown","ArrowRight","ArrowLeft"],s=r.key;i.indexOf(s)!==-1&&r.stopPropagation()})})}createExtentGraphic(){const l={type:"simple-fill",color:[0,0,0,.5],outline:null};this.extentGraphic=new m({symbol:l}),this.overview.graphics.add(this.extentGraphic)}};U([B.property()],x.prototype,"expand",2),x=U([B.subclass("esri.widgets.Overview")],x);class b{static addOverview(e,t,r,i,s){const a=new x({basemap:e,mainView:t,scales:r,factor:i}),o=new w({expandIconClass:"esri-icon-maps",view:t,content:a,expanded:s==="expanded",mode:"floating",autoCollapse:!1,group:"api"});a.expand=o,t.ui.add(o,{position:"bottom-right"})}static addLayerList(e,t){const r=new te({view:e}),i=new w({expandIconClass:"esri-icon-layers",view:e,content:r,expanded:t==="expanded",mode:"floating",autoCollapse:!1,group:"api"});e.ui.add(i,{position:"top-right"})}static addBasemapGallery(e,t){const r=new X({source:new Y({basemaps:e}),view:t});r.viewModel.basemapEquals=(s,a)=>s.id===a.id;const i=new w({expandIconClass:"esri-icon-basemap",view:t,content:r,mode:"floating",autoCollapse:!0,group:"api"});t.ui.add(i,{position:"top-right"})}static addCoordinates(e,t){const r=new Z({view:e});r.visibleElements={expandButton:!1},r.when(()=>{const s=setInterval(()=>{const p=document.getElementsByClassName("esri-coordinate-conversion")[0];p&&(clearInterval(s),p.style.width="300px")},50),a=r.formats.find(p=>p.name==="basemap"),o=new ee({name:"mn95",coordinateSegments:a.coordinateSegments,spatialReference:a.spatialReference});r.formats=r.formats.filter(p=>p.name==="dd"),r.formats.add(o,0),r.conversions.removeAll();const c=new Q({format:o});r.conversions.add(c)});const i=new w({expandIconClass:"esri-icon-locate",view:e,content:r,expanded:t==="expanded",mode:"floating",autoCollapse:!1,group:"api"});e.ui.add(i,{position:"bottom-right"})}}class ge{constructor(e){this.config=e,this.layerUtils=new he(e)}init(e){const t=this.layerUtils.getBasemaps(this.config.basemaps),r=new C({basemap:t[0]}),i=new q({wkid:this.config.spatialReference}),s=new u({x:this.config.center[0],y:this.config.center[1],spatialReference:i}),a=L.create({spatialReference:i,numLODs:this.config.scales.length,scales:this.config.scales}),o=new g({xmin:this.config.globalExtent.xmin,ymin:this.config.globalExtent.ymin,xmax:this.config.globalExtent.xmax,ymax:this.config.globalExtent.ymax,spatialReference:i});this.view=new P({container:this.config.container,map:r,scale:this.config.scale,center:s,spatialReference:i,constraints:{rotationEnabled:!1,lods:a.lods,minScale:this.config.minScale,maxScale:this.config.maxScale,geometry:o},popup:{dockEnabled:!0,dockOptions:{buttonEnabled:!1,breakpoint:!1},viewModel:{includeDefaultActions:!1}}}),this.view.when(()=>{e.emit("map-created")});const c=new O({view:this.view,unit:"metric"});if(this.view.ui.add(c,{position:"bottom-left"}),this.config.layers&&this.layerUtils.getMapImageLayers(this.config.layers).then(p=>{this.view.map.addMany(p.reverse())}),t.length>1&&b.addBasemapGallery(t,this.view),this.config.layerList&&b.addLayerList(this.view,this.config.layerList),this.config.overviewDisplay&&this.config.overviewBasemap){const p=this.layerUtils.getBasemaps([this.config.overviewBasemap])[0];b.addOverview(p,this.view,this.config.scales,this.config.overviewFactor,this.config.overviewDisplay)}this.config.showCoords&&b.addCoordinates(this.view,this.config.showCoords),this.view.on("click",p=>{p.native.ctrlKey&&(p.stopPropagation(),e.emit("ctrlClick",[p.mapPoint.x,p.mapPoint.y]))})}center(e,t){this.view.center=new u({x:e[0],y:e[1],spatialReference:this.view.spatialReference}),t!==void 0&&(this.view.scale=t)}centerOnObject(e,t,r){this.view.graphics.removeAll();const i=this.config.vectorLayerQueries.filter(s=>s.layer===e)[0];if(!i){console.warn(`Invalid layer name: ${e}`);return}this.layerUtils.queryLayer(i,t).then(s=>{if(!s.length){console.warn("No object found with this query.");return}const a=this.getGlobalExtent(s,1.5);if(this.view.extent=a,r){const o={point:this.config.selectionPointSymbol,multipoint:this.config.selectionPointSymbol,polyline:this.config.selectionPolylineSymbol,polygon:this.config.selectionPolygonSymbol};s.forEach(c=>{const p=new m({geometry:c,symbol:o[c.type]});this.view.graphics.add(p)})}})}getCenterCoordinates(){return[this.view.center.x,this.view.center.y]}showPopup(e,t){this.view.openPopup({title:e,content:t})}addMarker(e){const t=this.config.markerSymbol;e!==void 0&&e.icon&&e.size&&(t.url=e.icon,t.width=`${e.size[0]}px`,t.height=`${e.size[1]}px`);const r=e!==void 0&&e.position?e.position:this.getCenterCoordinates(),i=new u({x:r[0],y:r[1],spatialReference:this.view.spatialReference}),s=new m({geometry:i,symbol:t});this.view.graphics.add(s)}addGpxLayer(e,t,r){this.isValidLayerName(e)&&ce.gpxToFeatures(t,this.view.spatialReference).then(i=>{const s={point:this.config.gpxPointSymbol,polyline:this.config.gpxPolylineSymbol,polygon:this.config.gpxPolygonSymbol},a=[];i.tracks.forEach(o=>{o.symbol=s[o.geometry.type],a.push(o)}),i.waypoints.forEach(o=>{o.symbol=s[o.geometry.type],a.push(o)}),this.addGraphicsLayer(a,e,r)})}addTextLayer(e,t,r){this.isValidLayerName(e)&&ue.txtToFeatures(t,this.view.spatialReference).then(i=>{this.addGraphicsLayer(i,e,r)})}getGlobalExtent(e,t){const r=s=>{const a=s.extent;if(a&&a.width&&a.height)return a.expand(t);const o=s.type==="point"?[s.x,s.y]:s.points[0],c=50;return new g({xmin:o[0]-c,ymin:o[1]-c,xmax:o[0]+c,ymax:o[1]+c,spatialReference:this.view.spatialReference})};let i;return e.forEach(s=>{i?i.union(r(s)):i=r(s.clone())}),i.expand(t)}isValidLayerName(e){return this.view.map.layers.some(t=>t.title===e)?(console.warn(`Map already contains a layer called '${e}'.`),!1):!0}addGraphicsLayer(e,t,r){const i=new G({title:t});if(this.view.map.add(i),i.graphics.addMany(e),r){const s=e.map(o=>o.geometry),a=this.getGlobalExtent(s,1.5);this.view.extent=a}}}class me{static getConfig(e){return new Promise((t,r)=>{f(e.configUrl,{responseType:"json"}).then(i=>{const s=i.data;let a,o,c;if(e.miniMap!==void 0){c=e.miniMap;const d=this.getBasemap(s.basemaps,s.overviewBasemap);d&&(a=d),o=s.overviewFactor}let p;e.layerList!==void 0&&e.layers&&e.layers.length&&(p=e.layerList);let h=s.vectorServiceUrl;h.substring(h.length-1)==="/"&&(h=h.substring(0,h.length-1)),t({apiUrl:s.apiUrl,basemaps:this.getBasemaps(s,e),center:e.center||s.center,container:e.container,globalExtent:s.globalExtent,gpxPointSymbol:s.gpxPointSymbol,gpxPolylineSymbol:s.gpxPolylineSymbol,gpxPolygonSymbol:s.gpxPolygonSymbol,layers:e.layers,layerList:p,markerSymbol:s.markerSymbol,maxScale:s.maxScale,minScale:s.minScale,overviewBasemap:a,overviewDisplay:c,overviewFactor:o,scale:e.scale||s.scale,scales:s.scales,selectionPointSymbol:s.selectionPointSymbol,selectionPolylineSymbol:s.selectionPolylineSymbol,selectionPolygonSymbol:s.selectionPolygonSymbol,spatialReference:s.spatialReference,showCoords:e.showCoords,vectorLayerQueries:s.vectorLayerQueries,vectorServiceUrl:h,vectorServiceToken:s.vectorServiceToken})}).catch(i=>{r(i)})})}static getBasemaps(e,t){const r=[];if(t.basemaps===void 0){const i=this.getBasemap(e.basemaps,e.defaultBasemap,e.copyright);i&&r.push(i)}else t.basemaps.forEach(i=>{const s=this.getBasemap(e.basemaps,i,e.copyright);s&&r.push(s)});return r}static getBasemap(e,t,r){const i=e[t];return i?{alias:i.alias,copyright:r,layerId:i.layerId,name:t,thumbnailUrl:i.thumbnailUrl,type:i.type,url:i.url,urlTemplate:i.urlTemplate}:(console.warn(`Invalid basemap name: ${t}`),null)}}class fe{constructor(e){this.emitter=ne(),me.getConfig(e).then(t=>{let r=t.apiUrl;r.charAt(r.length-1)!=="/"&&(r+="/"),n.assetsPath=`${r}@arcgis/core/assets`;const i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.setAttribute("href",`${r}@arcgis/core/assets/esri/themes/light/main.css`),document.getElementsByTagName("head")[0].appendChild(i),this.map=new ge(t),this.map.init(this.emitter)}).catch(t=>{console.error(t)})}on(e,t){return this.emitter.on(e,t)}center(e,t){this.callMapFunction(()=>this.map.center(e,t))}centerOnObject(e,t,r){this.callMapFunction(()=>this.map.centerOnObject(e,t,r))}addGpxLayer(e,t,r){this.callMapFunction(()=>this.map.addGpxLayer(e,t,r))}addTextLayer(e,t,r){this.callMapFunction(()=>this.map.addTextLayer(e,t,r))}addMarker(e){this.callMapFunction(()=>this.map.addMarker(e))}showPopup(e,t){this.map.showPopup(e,t)}callMapFunction(e){this.map?e():this.emitter.on("map-created",()=>e())}}return fe});
//# sourceMappingURL=main.js.map
